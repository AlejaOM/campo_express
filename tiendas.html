<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tiendas - CampoExpress</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon" href="./assets/logo.jpeg" type="image/jpeg">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="./css/style.css">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    .product-card {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    #map {
      height: 500px;
      width: 100%;
      border-radius: 10px;
    }
    .leaflet-popup-content {
      margin: 8px 12px;
    }
    .custom-popup h6 {
      color: var(--primary-color);
      margin-bottom: 5px;
    }
    .custom-popup p {
      margin: 2px 0;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <!-- Navbar unificado se cargará automáticamente aquí -->

  <div class="container mt-4" id="app">
    <h2 class="mb-4">
      <i class="fas fa-store text-custom me-2"></i>
      Nuestras Tiendas
    </h2>
    
    <!-- Barra de búsqueda -->
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="input-group">
          <span class="input-group-text bg-custom text-white">
            <i class="fas fa-search"></i>
          </span>
          <input type="text" class="form-control form-control-custom" placeholder="Buscar tiendas..." v-model="busqueda">
        </div>
      </div>
      <div class="col-md-6">
        <div class="d-flex justify-content-end gap-2">
          <button class="btn btn-outline-custom" @click="mostrarTodasTiendasEnMapa()">
            <i class="fas fa-map me-1"></i>Ver Mapa
          </button>
          <span class="badge badge-custom fs-6">
            {{ tiendasFiltradas.length }} tienda(s)
          </span>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6 mb-4" v-for="tienda in tiendasFiltradas" :key="tienda.id">
        <div class="card card-custom h-100">
          <img :src="tienda.imagen" class="card-img-top" style="height: 200px; object-fit: cover;" 
               @error="manejarErrorImagen" :alt="tienda.nombre">
          <div class="card-body d-flex flex-column">
            <h5 class="card-title text-custom">{{ tienda.nombre }}</h5>
            <p class="card-text text-muted small">
              <i class="fas fa-boxes me-1"></i>
              {{ tienda.productos.length }} productos disponibles
            </p>
            <p class="card-text text-muted small" v-if="tienda.distancia">
              <i class="fas fa-location-arrow me-1"></i>
              A {{ tienda.distancia }} km de ti
            </p>
            <div class="mt-auto d-flex gap-2">
              <button class="btn btn-custom flex-fill" @click="verTienda(tienda.id)">
                <i class="fas fa-eye me-2"></i>Productos
              </button>
              <button class="btn btn-outline-custom" @click="ubicarTiendaEnMapa(tienda)" 
                      title="Ubicar en el mapa">
                <i class="fas fa-map-marker-alt"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para productos -->
    <div class="modal fade" id="productosModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header card-header-custom">
            <h5 class="modal-title text-white">
              <i class="fas fa-shopping-basket me-2"></i>
              Productos de {{ tiendaSeleccionada?.nombre }}
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <!-- Filtro de productos en el modal -->
            <div class="row mb-3" v-if="tiendaSeleccionada">
              <div class="col-md-6">
                <input type="text" class="form-control form-control-custom" placeholder="Buscar productos..." 
                       v-model="filtroProductos" @input="filtrarProductos">
              </div>
              <div class="col-md-6 text-end">
                <span class="badge badge-custom fs-6">
                  {{ productosFiltrados.length }} producto(s)
                </span>
              </div>
            </div>

            <div class="row" v-if="tiendaSeleccionada">
              <div class="col-md-4 mb-3" v-for="producto in productosFiltrados" :key="producto.id">
                <div class="card card-custom h-100 product-card">
                  <img :src="producto.imagen" 
                       class="card-img-top" 
                       style="height: 180px; object-fit: cover;"
                       @error="manejarErrorImagenProducto"
                       :alt="producto.nombre">
                  <div class="card-body d-flex flex-column">
                    <h6 class="card-title">{{ producto.nombre }}</h6>
                    <p class="card-text text-custom fw-bold fs-5">${{ producto.precio.toLocaleString() }}</p>
                    <p class="card-text text-muted small flex-grow-1">
                      {{ tiendaSeleccionada.nombre }}
                    </p>
                    <button class="btn btn-custom btn-sm mt-auto" 
                            @click="agregarAlCarrito(producto, tiendaSeleccionada.nombre)">
                      <i class="fas fa-cart-plus me-1"></i>Agregar al Carrito
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Mensaje cuando no hay productos -->
            <div v-if="tiendaSeleccionada && productosFiltrados.length === 0" class="text-center py-4">
              <i class="fas fa-search fa-3x text-muted mb-3"></i>
              <h5 class="text-muted">No se encontraron productos</h5>
              <p class="text-muted">Intenta con otros términos de búsqueda</p>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            <a href="./carrito.html" class="btn btn-custom">
              <i class="fas fa-shopping-cart me-1"></i>Ver Carrito
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para el Mapa -->
    <div class="modal fade" id="mapaModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header card-header-custom">
            <h5 class="modal-title text-white">
              <i class="fas fa-map me-2"></i>
              <span id="mapaTitulo">Mapa de Tiendas</span>
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body p-3">
            <div id="map"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            <button class="btn btn-outline-custom" @click="mapaManager.centrarEnUbicacion()">
              <i class="fas fa-location-arrow me-1"></i>Mi Ubicación
            </button>
            <button class="btn btn-custom" @click="mapaManager.mostrarTodasTiendas()">
              <i class="fas fa-store me-1"></i>Todas las Tiendas
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container para mensajes -->
  <div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="./js/app.js"></script>
  <script src="./js/carrito.js"></script>
  <script src="./js/navbar.js"></script>
  <script src="./js/mapa-leaflet.js"></script>
  <script>
    const { createApp } = Vue;
    
    // Variable global para el manager del mapa
    let mapaManager;

    createApp({
      data() {
        return {
          tiendas: window.tiendas || [],
          tiendaSeleccionada: null,
          busqueda: '',
          filtroProductos: '',
          productosFiltrados: [],
          ubicacionUsuario: null
        }
      },
      computed: {
        tiendasFiltradas() {
          if (!this.busqueda) return this.tiendas;
          return this.tiendas.filter(tienda => 
            tienda.nombre.toLowerCase().includes(this.busqueda.toLowerCase())
          );
        }
      },
      methods: {
        verTienda(id) {
          this.tiendaSeleccionada = this.tiendas.find(t => t.id === id);
          this.filtroProductos = '';
          this.productosFiltrados = this.tiendaSeleccionada?.productos || [];
          
          const modal = new bootstrap.Modal(document.getElementById('productosModal'));
          modal.show();
        },
        filtrarProductos() {
          if (!this.tiendaSeleccionada) return;
          
          if (!this.filtroProductos) {
            this.productosFiltrados = this.tiendaSeleccionada.productos;
          } else {
            const filtro = this.filtroProductos.toLowerCase();
            this.productosFiltrados = this.tiendaSeleccionada.productos.filter(producto =>
              producto.nombre.toLowerCase().includes(filtro)
            );
          }
        },
        async ubicarTiendaEnMapa(tienda) {
          if (!mapaManager) {
            this.mostrarMensaje('El mapa aún no está cargado', 'warning');
            return;
          }
          
          await mapaManager.inicializarMapa();
          mapaManager.mostrarTiendaEspecifica(tienda);
          
          const modal = new bootstrap.Modal(document.getElementById('mapaModal'));
          modal.show();
        },
        async mostrarTodasTiendasEnMapa() {
          if (!mapaManager) {
            this.mostrarMensaje('El mapa aún no está cargado', 'warning');
            return;
          }
          
          await mapaManager.inicializarMapa();
          mapaManager.mostrarTodasTiendas();
          
          const modal = new bootstrap.Modal(document.getElementById('mapaModal'));
          modal.show();
        },
        manejarErrorImagen(event) {
          event.target.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiM5OTkiIGR5PSIuM2VtIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5UaWVuZGE8L3RleHQ+PC9zdmc+';
        },
        manejarErrorImagenProducto(event) {
          event.target.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5OTkiIGR5PSIuM2VtIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5Qcm9kdWN0bzwvdGV4dD48L3N2Zz4=';
        },
        agregarAlCarrito(producto, tiendaNombre) {
          if (window.agregarAlCarrito) {
            window.agregarAlCarrito(producto, tiendaNombre);
          } else {
            const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
            carrito.push({
              ...producto,
              cantidad: 1,
              idCarrito: Date.now() + Math.random().toString(36).substr(2, 9),
              tiendaNombre: tiendaNombre
            });
            localStorage.setItem('carrito', JSON.stringify(carrito));
            
            if (window.navbarManager) {
              window.navbarManager.actualizarContadorCarrito();
            }
            
            alert(`✅ ${producto.nombre} agregado al carrito!`);
          }
        },
        mostrarMensaje(mensaje, tipo = 'info') {
          const toastContainer = document.getElementById('toastContainer');
          const toast = document.createElement('div');
          toast.className = `toast align-items-center text-bg-${tipo} border-0`;
          toast.innerHTML = `
            <div class="d-flex">
              <div class="toast-body">
                <i class="fas fa-${tipo === 'success' ? 'check' : tipo === 'warning' ? 'exclamation' : 'info'}-circle me-2"></i>
                ${mensaje}
              </div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
          `;
          toastContainer.appendChild(toast);
          new bootstrap.Toast(toast).show();
          setTimeout(() => toast.remove(), 5000);
        }
      },
      async mounted() {
        // Inicializar el mapa manager
        if (typeof MapaManager !== 'undefined') {
          mapaManager = new MapaManager(this.tiendas);
        }
        
        if (window.navbarManager) {
          window.navbarManager.controlarVisibilidadCarrito();
        }
      }
    }).mount('#app');
  </script>
</body>
</html>